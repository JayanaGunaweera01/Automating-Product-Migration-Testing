name: ğŸ§ğŸğŸªŸ Migration Tester

on:
  workflow_dispatch:
    inputs:
      currentVersion:
        description: "ğŸ–¥ï¸ Specify the version of WSO2 IS that is presently installed in your environment."
        default: "5.11.0"
        type: choice
        options:
          - "5.9.0"
          - "5.10.0"
          - "5.11.0"
          - "6.0.0"
          - "6.1.0"
          - "6.2.0"
      migratingVersion:
        description: "ğŸ’» Specify the version of WSO2 IS that you want to migrate."
        default: "6.0.0"
        type: choice
        options:
          - "5.10.0"
          - "5.11.0"
          - "6.0.0"
          - "6.1.0"
          - "6.2.0"
      database:
        description: "ğŸ˜ Select the database."
        default: "mysql"
        type: choice
        options:
          - "mysql"
          - "mssql"
          - "postgres"
      os:
        description: "ğŸ§ Select the OS."
        default: "ubuntu-latest"
        type: choice
        options:
          - "ubuntu-latest"
          - "macos-latest"
          - "windows-latest"
      urlOld:
        description: "ğŸ”— Provide the URL to download the old version of WSO2 IS."
        default: https://github.com/wso2/product-is/releases/download/v5.11.0/wso2is-5.11.0.zip
        required: true
      urlNew:
        description: "ğŸ”—ğŸ†• Provide the URL to download the version you want to upgrade WSO2 IS."
        default: https://github.com/wso2/product-is/releases/download/v6.0.0-rc2/wso2is-6.0.0-rc2.zip
        required: true
jobs:
  ubuntu-postgres-setup:
    if: ${{ github.event.inputs.database == 'postgres' && github.event.inputs.os == 'ubuntu-latest' }}
    runs-on: ${{ github.event.inputs.os }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2
      - name: ğŸ³ Setup Docker environment
        run: |
          # Get the ID of the workflow from the GitHub API using curl and jq
          WORKFLOW_ID=$(curl -s -H "Accept: application/vnd.github.v3+json" https://api.github.com/repos/JayanaGunaweera01/Automate-Product-Migration-Testing/actions/workflows | jq -r '.workflows[] | select(.name == "Main Migration Workflow ğŸ§ğŸğŸªŸ") | .id')
          echo "Workflow ID: $WORKFLOW_ID"
          # Update and upgrade packages, and install necessary dependencies
          sudo apt-get update
          sudo apt-get upgrade
          sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common
          # Add Docker GPG key and add the Docker repository
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
          # Update the packages again and install Docker CE
          sudo apt-get update
          sudo apt-get install -y docker-ce
      - name: ğŸ‹ Run Docker command
        run: |
          # Create the PostgreSQL container if it doesn't already exist
          if ! docker ps -a | grep postgres; then
            echo "Creating the PostgreSQL container..."
            docker run -d -p 5432:5432 --name postgres -e POSTGRES_PASSWORD=postgres postgres
            sleep 20
            echo "PostgreSQL container created successfully."
          fi
          # Start the PostgreSQL server if it's not running
          if ! docker ps | grep postgres; then
            echo "Starting the PostgreSQL server..."
            docker start postgres
            sleep 20
            echo "PostgreSQL server started successfully."
          fi

          # Create a new database 'testdb'
          docker exec -i postgres psql -U postgres -c "CREATE DATABASE testdb;"
          echo "Database created successfully!"
          # Grant all privileges to postgres user
          docker exec -i postgres psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE testdb TO postgres;"
          echo "Database privileges granted successfully!"
          # Change the password for role postgres
          docker exec -i postgres psql -U postgres -c "ALTER USER postgres WITH PASSWORD 'postgres';"
          echo "Password for role 'postgres' changed successfully!"

      - name: ğŸšš Copy SQL file to PostgreSQL container
        run: |
          docker cp /home/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/postgresone.sql postgres:/
          docker exec -i postgres sh -c 'exec psql -U postgres -d testdb < /postgresone.sql'
          echo "Postgre database created successfully!"
          docker cp /home/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/identity/postgrestwo.sql postgres:/
          docker exec -i postgres sh -c 'exec psql -U postgres -d testdb < /postgrestwo.sql '
          echo "Script1 executed successfully!"
          docker cp /home/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/identity/uma/postgresthree.sql postgres:/
          docker exec -i postgres sh -c 'exec psql -U postgres -d testdb < /postgresthree.sql'
          echo "Script2 executed successfully!"
          docker cp /home/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/consent/postgresfour.sql postgres:/
          docker exec -i postgres sh -c 'exec psql -U postgres -d testdb < /postgresfour.sql'
          echo "Script3 executed successfully!"
          docker cp /home/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/metrics/postgresfive.sql postgres:/
          docker exec -i postgres sh -c 'exec psql -U postgres -d testdb < /postgresfive.sql'
          echo "All postgre scripts executed successfully!"

  ubuntu-mysql-setup:
    if: ${{ github.event.inputs.database == 'mysql' && github.event.inputs.os == 'ubuntu-latest' }}
    runs-on: ${{ github.event.inputs.os }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2

  ubuntu-mssql-setup:
    if: ${{ github.event.inputs.database == 'mssql' && github.event.inputs.os == 'ubuntu-latest' }}
    runs-on: ${{ github.event.inputs.os }}
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2019-latest
        env:
          SA_PASSWORD: YourStrongPassw0rd
          ACCEPT_EULA: Y
          MSSQL_PID: Developer
        ports:
          - 1433:1433
        options: --name=sqlserver-test --health-cmd="/opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -Q 'SELECT 1'" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ—ï¸ Create MS SQL Database
        run: |
          sudo apt-get update && sudo apt-get install -y mssql-tools
          /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -Q 'CREATE DATABASE testdb'
      - name: ğŸšš Copy SQL files to MSSQL container
        run: |

          docker cp ./utils/db-scripts/IS-5.11/mssql.sql sqlserver-test:/mssql.sql
          docker exec sqlserver-test /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -d testdb -i /mssql.sql
          docker cp ./utils/db-scripts/IS-5.11/identity/mssql.sql sqlserver-test:/identity-mssql.sql
          docker exec sqlserver-test /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -d testdb -i /identity-mssql.sql
          docker cp ./utils/db-scripts/IS-5.11/identity/uma/mssql.sql sqlserver-test:/identity-uma-mssql.sql
          docker exec sqlserver-test /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -d testdb -i /identity-uma-mssql.sql
          docker cp ./utils/db-scripts/IS-5.11/consent/mssql.sql sqlserver-test:/consent-mssql.sql
          docker exec sqlserver-test /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -d testdb -i /consent-mssql.sql
          docker cp ./utils/db-scripts/IS-5.11/metrics/mssql.sql sqlserver-test:/metrics-mssql.sql
          docker exec sqlserver-test /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P 'YourStrongPassw0rd' -d testdb -i /metrics-mssql.sql
          echo "Copied mssql scripts to docker container"
  macos-mysql-setup:
    if: ${{ github.event.inputs.database == 'mysql' && github.event.inputs.os == 'macos-latest' }}
    runs-on: ${{ github.event.inputs.os }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2

  macos-postgres-setup:
    runs-on: ${{ github.event.inputs.os }}
    if: ${{ github.event.inputs.database == 'postgres' && github.event.inputs.os == 'macos-latest' }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2

        env:
          PGDATA: /usr/local/var/postgres
          PGDATABASE: testdb
          run: |
            brew update
            brew install postgresql
            initdb $PGDATA
            pg_ctl -D $PGDATA start
            createuser -s postgres
            createdb $PGDATABASE
            psql -c "GRANT ALL PRIVILEGES ON DATABASE $PGDATABASE TO postgres;"
      - name: ğŸ˜ Execute Postgres SQL scripts
        run: |
          psql -d testdb -f /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/postgresone.sql
          psql -d testdb -f /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/consent/postgresfour.sql
          psql -d testdb -f /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/identity/postgrestwo.sql
          psql -d testdb -f /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/identity/uma/postgresthree.sql
          psql -d testdb -f /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/metrics/postgresfive.sql
      - name: âœ… Verify script execution
        run: psql -d testdb -c 'SHOW server_version'
        shell: bash

  macos-mssql-setup:
    if: ${{ github.event.inputs.database == 'mssql' && github.event.inputs.os == 'macos-latest' }}
    runs-on: ${{ github.event.inputs.os }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2

      - uses: potatoqualitee/mssqlsuite@v1.7
        with:
          install: sqlengine, sqlclient, sqlpackage, localdb
          version: 2019
          SA-password: YourStrongPassw0rd

      - name: ğŸ—ï¸ Create MS SQL Database
        run: sqlcmd -U SA -P 'YourStrongPassw0rd' -Q 'CREATE DATABASE testdb'
      - name: Run query
        run: sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -Q 'SELECT @@VERSION'

      - name: ğŸŒ Execute MSSQL Scripts ğŸ Mac
        run: |
          sqlcmd -U SA -P 'YourStrongPassw0rd' -Q 'CREATE DATABASE testdb'
          sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -Q 'SELECT @@VERSION'
          sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -i /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/mssql.sql
          sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -i /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/identity/mssql.sql
          sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -i /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/identity/uma/mssql.sql
          sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -i /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/consent/mssql.sql
          sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -i /Users/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/utils/db-scripts/IS-5.11/metrics/mssql.sql

      - name: âœ… Verify script execution
        run: sqlcmd -U SA -P 'YourStrongPassw0rd' -d testdb -Q 'SELECT @@VERSION'
  execute-migration:
    needs:
      [
        ubuntu-postgres-setup,
        ubuntu-mssql-setup,
        macos-mssql-setup,
        macos-postgres-setup,
        ubuntu-mysql-setup,
        macos-mysql-setup,
      ]
    if: always() && !cancelled()
    runs-on: ${{ github.event.inputs.os }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2
      - name: ğŸ¤– Download Migration Client
        #env:
        #MIGRATION_PAT: ${{ secrets.MIGRATION_PAT }}
        run: |

          readonly github_repo_owner="wso2-extensions"
          readonly github_repo_name="identity-migration-resources"
          readonly tag="1.0.225"
          readonly asset_file_name_with_ext="wso2is-migration-$tag.zip"

          github_tag_url=$(curl --silent --show-error \
                --header "Authorization: token $MIGRATION_PAT" \
                --header "Accept: application/json, application/vnd.github.v3+json" \
                --request GET "https://api.github.com/repos/$github_repo_owner/$github_repo_name/releases?per_page=100&draft=false" |
                jq -r '.url') &&
              readonly github_tag_url &&
              echo "Discovered the github_tag_url: ${github_tag_url}" &&

          github_tag_id=$(curl --silent --show-error \
                --header "Authorization: token $MIGRATION_PAT" \
                --header "Accept: application/json, application/vnd.github.v3+json" \
                --request GET "${github_tag_url}" | 
              jq --raw-output "first(.[] | select(.tag_name==\"v$tag\")).id") &&
              readonly github_tag_id &&
              echo "Discovered the tag_id: ${github_tag_id}" &&
              echo "Creating the download link..." &&

              # Get the download URL of our desired asset
              download_url=$(curl --silent --show-error \
                --header "Authorization: token $MIGRATION_PAT" \
                --header "Accept: application/json, application/vnd.github.v3+json" \
                --location --request "GET" \
                "https://api.github.com/repos/$github_repo_owner/$github_repo_name/releases/$github_tag_id" |
                jq --raw-output ".assets[] | select(.name==\"${asset_file_name_with_ext}\").url") &&
              readonly download_url &&
              echo "Found resource download url: $download_url" &&
              echo "Discovering the S3 bucket url for resource..." &&

              
              redirect_url=$(curl --silent --show-error \
                --header "Accept: application/octet-stream" \
                --header "Authorization: token $MIGRATION_PAT" \
                --request GET --write-out "%{redirect_url}" \
                "$download_url") &&
              readonly redirect_url &&
              echo "Download is starting now..." &&

            # Finally download the actual binary.
            curl -LJO --show-error \
              --output "/home/runner/work/Automating-Product-Migration-Testing/Automating-Product-Migration-Testing/migration-automation" \
              --request GET \
              "$redirect_url" &&
            echo "Binary $asset_file_name_with_ext download is completed."

      - name: ğŸ’µ Cache Logs
        id: cache-logs
        uses: actions/cache@v2
        env:
          cache-name: cache-logs
        with:
          path: ${{ github.workspace }}/migration-automation/logs.txt
          key: logs-${{ github.event.inputs.currentVersion }}-${{ github.event.inputs.migratingVersion }}-${{ github.event.inputs.database }}-${{ github.event.inputs.os }}
          restore-keys: logs-${{ github.event.inputs.currentVersion }}-${{ github.event.inputs.migratingVersion }}-${{ github.event.inputs.database }}-${{ github.event.inputs.os }}

      - name: ğŸš€ Execute Migration Automation Script ğŸ§ Ubuntu
        if: ${{ (github.event.inputs.database == 'mssql' || github.event.inputs.database == 'mysql' || github.event.inputs.database == 'postgres' || github.event.inputs.database == 'mysql' || github.event.inputs.database == 'mysql') && github.event.inputs.os == 'ubuntu-latest' }}
        run: |
          chmod +x migration-automation/ubuntu-os/migration-script-ubuntu.sh 
          sh migration-automation/ubuntu-os/migration-script-ubuntu.sh "${{ github.event.inputs.urlOld }}" "${{ github.event.inputs.urlNew }}" "${{ github.event.inputs.currentVersion }}" "${{ github.event.inputs.migratingVersion }}" "${{ github.event.inputs.database }}" "${{ github.event.inputs.os }}" | tee "migration-automation/logs.txt"
        continue-on-error: true

      - name: ğŸš€ Execute Migration Automation Script ğŸ Mac
        if: ${{ (github.event.inputs.database == 'mssql' || github.event.inputs.database == 'postgres' || github.event.inputs.database == 'mysql') && github.event.inputs.os == 'macos-latest' }}
        run: |
          chmod +x migration-automation/mac-os/migration-script-mac.sh 
          sh migration-automation/mac-os/migration-script-mac.sh "${{ github.event.inputs.urlOld }}" "${{ github.event.inputs.urlNew }}" "${{ github.event.inputs.currentVersion }}" "${{ github.event.inputs.migratingVersion }}" "${{ github.event.inputs.database }}" "${{ github.event.inputs.os }}" | tee "migration-automation/logs.txt"
        continue-on-error: true
      - name: ğŸ“‹ Persist Logs
        run: |
          mkdir -p migration-automation/artifacts
          cp migration-automation/logs.txt migration-automation/artifacts/
        if: ${{ always() }}
      - name: ğŸ“¦ Upload Artifacts
        uses: actions/upload-artifact@v2
        if: always()
        with:
          name: "logs-${{ github.event.inputs.currentVersion }}-${{ github.event.inputs.migratingVersion }}-${{ github.event.inputs.database }}-${{ github.event.inputs.os }}"
          path: migration-automation/artifacts

  validate-migration:
    needs: execute-migration
    if: always()
    runs-on: ${{ github.event.inputs.os }}
    steps:
      - name: ğŸ’¾ Checkout code
        uses: actions/checkout@v2
      - name: ğŸ“¦ Download Artifacts
        uses: actions/download-artifact@v2
        if: always()
        with:
          name: "logs-${{ github.event.inputs.currentVersion }}-${{ github.event.inputs.migratingVersion }}-${{ github.event.inputs.database }}-${{ github.event.inputs.os }}"
          path: migration-automation/artifacts
          retention-days: 7
      - name: ğŸ’¥ Post Migration Testing
        run: |
          # Access logs from the downloaded artifacts folder
          while IFS= read -r line; do
            if echo "$line" | grep -i -q "ERROR\|error\|Error"; then
              echo -e "\e[91m$line\e[0m"
            else
              echo "$line"
            fi
          done < migration-automation/artifacts/logs.txt
